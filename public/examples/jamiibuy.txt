#!/bin/bash


buyerID=
buyerBalance=
auctionID=
amount=
vegetable=
price=
confirm=
auction_response=
sellerID=
remain=
if [ "$1" = "-ID" ]; then
	shift
	buyerID="$1"
	shift
else
	echo "No ID?"
	read -s
	exit
fi


clear
echo "Skriv auktions-id'et du vil købe fra, eller skriv 'exit' for at afslutte."
read auctionID

if [ "$auctionID" = "exit" ]; then
	exit
fi

auction_response=$(curl -s -d "auctionID=$auctionID" http://***.***.***.***/getSingleAuction.php)
user_response=$(curl -s -d "userID=$buyerID" http://***.***.***.***/getSingleUser.php)
if [ "$auction_response" = "No_Auction" ]; then
	echo "Ingen auktion ved det nummer, tryk enter for at prøve igen"
	read -s
fi

price=$(echo $auction_response | jq '.[0].price' | sed 's/"//g')
vegetable=$(echo $auction_response | jq '.[0].vegetable' | sed 's/"//g')
sellerID=$(echo $auction_response | jq '.[0].sellerID'| sed 's/"//g')
location=$(echo $auction_response | jq '.[0].location'| sed 's/"//g')
remain=$(echo $auction_response | jq '.[0].amount' | sed 's/"//g')
buyerBalance=$(echo $user_response | jq '.[0].greenpoints' | sed 's/"//g')
amountflag=false

until [ "$amountflag" = true ]; do
	clear
	echo "Hvor meget vil du købe? Der er ligenu $remain gram tilbage"
	read amount
	if [ "$amount" -le "$remain" ] && [ "$amount" -gt "0" ]; then
		amountflag=true
	else
		clear
		echo "Du har forsøgt at købe mere end der sælges"
		echo "Tryk enter for at forsøge igen"
		read -s
	fi
done 

let endPrice=$amount*$price/100
if [ "$endPrice" -gt "$buyerBalance" ]; then
	echo "Du har kun $buyerBalance og derfor ikke råd til dette køb"
	echo "Tryk enter for at afbryde"
	read -s
	exit
fi

clear
echo "Du er ved at købe $amount gram $vegetable for $endPrice GrøntPoint, er du sikker?"
echo "1) Ja"
echo "2) Nej"

until [ "$confirm" = "1" ] || [ "$confirm" = "2" ]; do
	read confirm
	clear
	case $confirm in
		1)	sqlResponse=$(curl -s -d "auctionID=$auctionID&amount=$amount&buyerID=$buyerID&endPrice=$endPrice&vegetable=$vegetable&sellerID=$sellerID" http://***.***.***.***/updateAuction.php)
			echo "Du har købt dine grøntsager, tryk enter for at gå tilbage til menuen"
			read -s
			;;
		2)
			;;
		*)	echo "Du skal vælge ja eller nej"
	esac
done
	
